<!-- Source: https://fastapi.tiangolo.com/advanced/async-tests/ -->

[ ]
[ ]

[Skip to content](#async-tests)

[Join the **FastAPI Cloud** waiting list ðŸš€](https://fastapicloud.com)

[Follow **@fastapi** on **X (Twitter)** to stay updated](https://x.com/fastapi)

[Follow **FastAPI** on **LinkedIn** to stay updated](https://www.linkedin.com/company/fastapi)

[Subscribe to the **FastAPI and friends** newsletter ðŸŽ‰](https://fastapi.tiangolo.com/newsletter/)

[sponsor
![](/img/sponsors/blockbee-banner.png)](https://blockbee.io?ref=fastapi "BlockBee Cryptocurrency Payment Gateway")

[sponsor
![](/img/sponsors/scalar-banner.svg)](https://github.com/scalar/scalar/?utm_source=fastapi&utm_medium=website&utm_campaign=top-banner "Scalar: Beautiful Open-Source API References from Swagger/OpenAPI files")

[sponsor
![](/img/sponsors/propelauth-banner.png)](https://www.propelauth.com/?utm_source=fastapi&utm_campaign=1223&utm_medium=topbanner "Auth, user management and more for your B2B product")

[sponsor
![](/img/sponsors/zuplo-banner.png)](https://zuplo.link/fastapi-web "Zuplo: Scale, Protect, Document, and Monetize your FastAPI")

[sponsor
![](/img/sponsors/liblab-banner.png)](https://liblab.com?utm_source=fastapi "liblab - Generate SDKs from FastAPI")

[sponsor
![](/img/sponsors/render-banner.svg)](https://docs.render.com/deploy-fastapi?utm_source=deploydoc&utm_medium=referral&utm_campaign=fastapi "Deploy & scale any full-stack web app on Render. Focus on building apps, not infra.")

[sponsor
![](/img/sponsors/coderabbit-banner.png)](https://www.coderabbit.ai/?utm_source=fastapi&utm_medium=banner&utm_campaign=fastapi "Cut Code Review Time & Bugs in Half with CodeRabbit")

[sponsor
![](/img/sponsors/subtotal-banner.svg)](https://subtotal.com/?utm_source=fastapi&utm_medium=sponsorship&utm_campaign=open-source "Making Retail Purchases Actionable for Brands and Developers")

[sponsor
![](/img/sponsors/railway-banner.png)](https://docs.railway.com/guides/fastapi?utm_medium=integration&utm_source=docs&utm_campaign=fastapi "Deploy enterprise applications at startup speed")

[sponsor
![](/img/sponsors/serpapi-banner.png)](https://serpapi.com/?utm_source=fastapi_website "SerpApi: Web Search API")

[![logo](../../img/icon-white.svg)](../.. "FastAPI")

FastAPI

Async Tests

* [en - English](/)
* [de - Deutsch](/de/)
* [es - espaÃ±ol](/es/)
* [fa - ÙØ§Ø±Ø³ÛŒ](/fa/)
* [fr - franÃ§ais](/fr/)
* [ja - æ—¥æœ¬èªž](/ja/)
* [ko - í•œêµ­ì–´](/ko/)
* [pt - portuguÃªs](/pt/)
* [ru - Ñ€ÑƒÑÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº](/ru/)
* [tr - TÃ¼rkÃ§e](/tr/)
* [uk - ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ° Ð¼Ð¾Ð²Ð°](/uk/)
* [vi - Tiáº¿ng Viá»‡t](/vi/)
* [zh - ç®€ä½“ä¸­æ–‡](/zh/)
* [zh-hant - ç¹é«”ä¸­æ–‡](/zh-hant/)
* [ðŸ˜‰](/em/)

Initializing search

[fastapi/fastapi](https://github.com/fastapi/fastapi "Go to repository")

* [FastAPI](../..)
* [Features](../../features/)
* [Learn](../../learn/)
* [Reference](../../reference/)
* [FastAPI People](../../fastapi-people/)
* [Resources](../../resources/)
* [About](../../about/)
* [Release Notes](../../release-notes/)

[![logo](../../img/icon-white.svg)](../.. "FastAPI")
FastAPI

[fastapi/fastapi](https://github.com/fastapi/fastapi "Go to repository")

* [FastAPI](../..)
* [Features](../../features/)
* [x]

  [Learn](../../learn/)

  Learn
  + [Python Types Intro](../../python-types/)
  + [Concurrency and async / await](../../async/)
  + [Environment Variables](../../environment-variables/)
  + [Virtual Environments](../../virtual-environments/)
  + [ ]

    [Tutorial - User Guide](../../tutorial/)

    Tutorial - User Guide
    - [First Steps](../../tutorial/first-steps/)
    - [Path Parameters](../../tutorial/path-params/)
    - [Query Parameters](../../tutorial/query-params/)
    - [Request Body](../../tutorial/body/)
    - [Query Parameters and String Validations](../../tutorial/query-params-str-validations/)
    - [Path Parameters and Numeric Validations](../../tutorial/path-params-numeric-validations/)
    - [Query Parameter Models](../../tutorial/query-param-models/)
    - [Body - Multiple Parameters](../../tutorial/body-multiple-params/)
    - [Body - Fields](../../tutorial/body-fields/)
    - [Body - Nested Models](../../tutorial/body-nested-models/)
    - [Declare Request Example Data](../../tutorial/schema-extra-example/)
    - [Extra Data Types](../../tutorial/extra-data-types/)
    - [Cookie Parameters](../../tutorial/cookie-params/)
    - [Header Parameters](../../tutorial/header-params/)
    - [Cookie Parameter Models](../../tutorial/cookie-param-models/)
    - [Header Parameter Models](../../tutorial/header-param-models/)
    - [Response Model - Return Type](../../tutorial/response-model/)
    - [Extra Models](../../tutorial/extra-models/)
    - [Response Status Code](../../tutorial/response-status-code/)
    - [Form Data](../../tutorial/request-forms/)
    - [Form Models](../../tutorial/request-form-models/)
    - [Request Files](../../tutorial/request-files/)
    - [Request Forms and Files](../../tutorial/request-forms-and-files/)
    - [Handling Errors](../../tutorial/handling-errors/)
    - [Path Operation Configuration](../../tutorial/path-operation-configuration/)
    - [JSON Compatible Encoder](../../tutorial/encoder/)
    - [Body - Updates](../../tutorial/body-updates/)
    - [ ]

      [Dependencies](../../tutorial/dependencies/)

      Dependencies
      * [Classes as Dependencies](../../tutorial/dependencies/classes-as-dependencies/)
      * [Sub-dependencies](../../tutorial/dependencies/sub-dependencies/)
      * [Dependencies in path operation decorators](../../tutorial/dependencies/dependencies-in-path-operation-decorators/)
      * [Global Dependencies](../../tutorial/dependencies/global-dependencies/)
      * [Dependencies with yield](../../tutorial/dependencies/dependencies-with-yield/)
    - [ ]

      [Security](../../tutorial/security/)

      Security
      * [Security - First Steps](../../tutorial/security/first-steps/)
      * [Get Current User](../../tutorial/security/get-current-user/)
      * [Simple OAuth2 with Password and Bearer](../../tutorial/security/simple-oauth2/)
      * [OAuth2 with Password (and hashing), Bearer with JWT tokens](../../tutorial/security/oauth2-jwt/)
    - [Middleware](../../tutorial/middleware/)
    - [CORS (Cross-Origin Resource Sharing)](../../tutorial/cors/)
    - [SQL (Relational) Databases](../../tutorial/sql-databases/)
    - [Bigger Applications - Multiple Files](../../tutorial/bigger-applications/)
    - [Background Tasks](../../tutorial/background-tasks/)
    - [Metadata and Docs URLs](../../tutorial/metadata/)
    - [Static Files](../../tutorial/static-files/)
    - [Testing](../../tutorial/testing/)
    - [Debugging](../../tutorial/debugging/)
  + [x]

    [Advanced User Guide](../)

    Advanced User Guide
    - [Path Operation Advanced Configuration](../path-operation-advanced-configuration/)
    - [Additional Status Codes](../additional-status-codes/)
    - [Return a Response Directly](../response-directly/)
    - [Custom Response - HTML, Stream, File, others](../custom-response/)
    - [Additional Responses in OpenAPI](../additional-responses/)
    - [Response Cookies](../response-cookies/)
    - [Response Headers](../response-headers/)
    - [Response - Change Status Code](../response-change-status-code/)
    - [Advanced Dependencies](../advanced-dependencies/)
    - [ ]

      [Advanced Security](../security/)

      Advanced Security
      * [OAuth2 scopes](../security/oauth2-scopes/)
      * [HTTP Basic Auth](../security/http-basic-auth/)
    - [Using the Request Directly](../using-request-directly/)
    - [Using Dataclasses](../dataclasses/)
    - [Advanced Middleware](../middleware/)
    - [Sub Applications - Mounts](../sub-applications/)
    - [Behind a Proxy](../behind-a-proxy/)
    - [Templates](../templates/)
    - [WebSockets](../websockets/)
    - [Lifespan Events](../events/)
    - [Testing WebSockets](../testing-websockets/)
    - [Testing Events: lifespan and startup - shutdown](../testing-events/)
    - [Testing Dependencies with Overrides](../testing-dependencies/)
    - [ ]

      Async Tests

      [Async Tests](./)

      Table of contents
      * [pytest.mark.anyio](#pytest-mark-anyio)
      * [HTTPX](#httpx)
      * [Example](#example)
      * [Run it](#run-it)
      * [In Detail](#in-detail)
      * [Other Asynchronous Function Calls](#other-asynchronous-function-calls)
    - [Settings and Environment Variables](../settings/)
    - [OpenAPI Callbacks](../openapi-callbacks/)
    - [OpenAPI Webhooks](../openapi-webhooks/)
    - [Including WSGI - Flask, Django, others](../wsgi/)
    - [Generating SDKs](../generate-clients/)
  + [FastAPI CLI](../../fastapi-cli/)
  + [ ]

    [Deployment](../../deployment/)

    Deployment
    - [About FastAPI versions](../../deployment/versions/)
    - [FastAPI Cloud](../../deployment/fastapicloud/)
    - [About HTTPS](../../deployment/https/)
    - [Run a Server Manually](../../deployment/manually/)
    - [Deployments Concepts](../../deployment/concepts/)
    - [Deploy FastAPI on Cloud Providers](../../deployment/cloud/)
    - [Server Workers - Uvicorn with Workers](../../deployment/server-workers/)
    - [FastAPI in Containers - Docker](../../deployment/docker/)
  + [ ]

    [How To - Recipes](../../how-to/)

    How To - Recipes
    - [General - How To - Recipes](../../how-to/general/)
    - [Migrate from Pydantic v1 to Pydantic v2](../../how-to/migrate-from-pydantic-v1-to-pydantic-v2/)
    - [GraphQL](../../how-to/graphql/)
    - [Custom Request and APIRoute class](../../how-to/custom-request-and-route/)
    - [Conditional OpenAPI](../../how-to/conditional-openapi/)
    - [Extending OpenAPI](../../how-to/extending-openapi/)
    - [Separate OpenAPI Schemas for Input and Output or Not](../../how-to/separate-openapi-schemas/)
    - [Custom Docs UI Static Assets (Self-Hosting)](../../how-to/custom-docs-ui-assets/)
    - [Configure Swagger UI](../../how-to/configure-swagger-ui/)
    - [Testing a Database](../../how-to/testing-database/)
* [ ]

  [Reference](../../reference/)

  Reference
  + [`FastAPI` class](../../reference/fastapi/)
  + [Request Parameters](../../reference/parameters/)
  + [Status Codes](../../reference/status/)
  + [`UploadFile` class](../../reference/uploadfile/)
  + [Exceptions - `HTTPException` and `WebSocketException`](../../reference/exceptions/)
  + [Dependencies - `Depends()` and `Security()`](../../reference/dependencies/)
  + [`APIRouter` class](../../reference/apirouter/)
  + [Background Tasks - `BackgroundTasks`](../../reference/background/)
  + [`Request` class](../../reference/request/)
  + [WebSockets](../../reference/websockets/)
  + [`HTTPConnection` class](../../reference/httpconnection/)
  + [`Response` class](../../reference/response/)
  + [Custom Response Classes - File, HTML, Redirect, Streaming, etc.](../../reference/responses/)
  + [Middleware](../../reference/middleware/)
  + [ ]

    [OpenAPI](../../reference/openapi/)

    OpenAPI
    - [OpenAPI `docs`](../../reference/openapi/docs/)
    - [OpenAPI `models`](../../reference/openapi/models/)
  + [Security Tools](../../reference/security/)
  + [Encoders - `jsonable_encoder`](../../reference/encoders/)
  + [Static Files - `StaticFiles`](../../reference/staticfiles/)
  + [Templating - `Jinja2Templates`](../../reference/templating/)
  + [Test Client - `TestClient`](../../reference/testclient/)
* [FastAPI People](../../fastapi-people/)
* [ ]

  [Resources](../../resources/)

  Resources
  + [Help FastAPI - Get Help](../../help-fastapi/)
  + [Development - Contributing](../../contributing/)
  + [Full Stack FastAPI Template](../../project-generation/)
  + [External Links and Articles](../../external-links/)
  + [FastAPI and friends newsletter](../../newsletter/)
  + [Repository Management Tasks](../../management-tasks/)
* [ ]

  [About](../../about/)

  About
  + [Alternatives, Inspiration and Comparisons](../../alternatives/)
  + [History, Design and Future](../../history-design-future/)
  + [Benchmarks](../../benchmarks/)
  + [Repository Management](../../management/)
* [Release Notes](../../release-notes/)

Table of contents

* [pytest.mark.anyio](#pytest-mark-anyio)
* [HTTPX](#httpx)
* [Example](#example)
* [Run it](#run-it)
* [In Detail](#in-detail)
* [Other Asynchronous Function Calls](#other-asynchronous-function-calls)

1. [FastAPI](../..)
2. [Learn](../../learn/)
3. [Advanced User Guide](../)

# Async Tests[Â¶](#async-tests "Permanent link")

You have already seen how to test your **FastAPI** applications using the provided `TestClient`. Up to now, you have only seen how to write synchronous tests, without using `async` functions.

Being able to use asynchronous functions in your tests could be useful, for example, when you're querying your database asynchronously. Imagine you want to test sending requests to your FastAPI application and then verify that your backend successfully wrote the correct data in the database, while using an async database library.

Let's look at how we can make that work.

## pytest.mark.anyio[Â¶](#pytest-mark-anyio "Permanent link")

If we want to call asynchronous functions in our tests, our test functions have to be asynchronous. AnyIO provides a neat plugin for this, that allows us to specify that some test functions are to be called asynchronously.

## HTTPX[Â¶](#httpx "Permanent link")

Even if your **FastAPI** application uses normal `def` functions instead of `async def`, it is still an `async` application underneath.

The `TestClient` does some magic inside to call the asynchronous FastAPI application in your normal `def` test functions, using standard pytest. But that magic doesn't work anymore when we're using it inside asynchronous functions. By running our tests asynchronously, we can no longer use the `TestClient` inside our test functions.

The `TestClient` is based on [HTTPX](https://www.python-httpx.org), and luckily, we can use it directly to test the API.

## Example[Â¶](#example "Permanent link")

For a simple example, let's consider a file structure similar to the one described in [Bigger Applications](../../tutorial/bigger-applications/) and [Testing](../../tutorial/testing/):

```
.
â”œâ”€â”€ app
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ main.py
â”‚Â Â  â””â”€â”€ test_main.py
```

The file `main.py` would have:

The file `test_main.py` would have the tests for `main.py`, it could look like this now:

## Run it[Â¶](#run-it "Permanent link")

You can run your tests as usual via:

```
$ pytest

---> 100%
```

## In Detail[Â¶](#in-detail "Permanent link")

The marker `@pytest.mark.anyio` tells pytest that this test function should be called asynchronously:

Tip

Note that the test function is now `async def` instead of just `def` as before when using the `TestClient`.

Then we can create an `AsyncClient` with the app, and send async requests to it, using `await`.

This is the equivalent to:

```
response = client.get('/')
```

...that we used to make our requests with the `TestClient`.

Tip

Note that we're using async/await with the new `AsyncClient` - the request is asynchronous.

Warning

If your application relies on lifespan events, the `AsyncClient` won't trigger these events. To ensure they are triggered, use `LifespanManager` from [florimondmanca/asgi-lifespan](https://github.com/florimondmanca/asgi-lifespan#usage).

## Other Asynchronous Function Calls[Â¶](#other-asynchronous-function-calls "Permanent link")

As the testing function is now asynchronous, you can now also call (and `await`) other `async` functions apart from sending requests to your FastAPI application in your tests, exactly as you would call them anywhere else in your code.

Tip

If you encounter a `RuntimeError: Task attached to a different loop` when integrating asynchronous function calls in your tests (e.g. when using [MongoDB's MotorClient](https://stackoverflow.com/questions/41584243/runtimeerror-task-attached-to-a-different-loop)), remember to instantiate objects that need an event loop only within async functions, e.g. an `@app.on_event("startup")` callback.

Back to top

[Previous

Testing Dependencies with Overrides](../testing-dependencies/)
[Next

Settings and Environment Variables](../settings/)

The FastAPI trademark is owned by [@tiangolo](https://tiangolo.com) and is registered in the US and across other regions

Made with
[Material for MkDocs](https://squidfunk.github.io/mkdocs-material/)