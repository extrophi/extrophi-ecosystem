name: Database Backups

# PROD-DELTA: Automated Database Backup and Disaster Recovery
#
# This workflow runs daily backups for:
# - PostgreSQL (research_db)
# - SQLite (BrainDump)
#
# Backups are:
# - Compressed and timestamped
# - Retained for 7 days
# - Uploaded to GitHub Artifacts (90 days retention)
# - Can be manually triggered

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Type of backup to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - postgres
          - sqlite

permissions:
  contents: read

jobs:
  backup-postgres:
    name: Backup PostgreSQL
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.backup_type == 'all' ||
      github.event.inputs.backup_type == 'postgres'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create backup directory
        run: mkdir -p /tmp/backups/postgres

      - name: Run PostgreSQL backup
        env:
          BACKUP_DIR: /tmp/backups/postgres
          DB_HOST: ${{ secrets.POSTGRES_HOST || 'localhost' }}
          DB_PORT: ${{ secrets.POSTGRES_PORT || '5432' }}
          DB_NAME: ${{ secrets.POSTGRES_DB || 'research_db' }}
          DB_USER: ${{ secrets.POSTGRES_USER || 'postgres' }}
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          chmod +x scripts/backup-postgres.sh
          ./scripts/backup-postgres.sh

      - name: Upload PostgreSQL backup
        uses: actions/upload-artifact@v4
        with:
          name: postgres-backup-${{ github.run_number }}
          path: /tmp/backups/postgres/*.sql.gz
          retention-days: 90
          if-no-files-found: error

      - name: Check backup success
        run: |
          if [ ! -f /tmp/backups/postgres/*.sql.gz ]; then
            echo "ERROR: PostgreSQL backup file not found"
            exit 1
          fi
          echo "PostgreSQL backup completed successfully"

  backup-sqlite:
    name: Backup SQLite
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.backup_type == 'all' ||
      github.event.inputs.backup_type == 'sqlite'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install SQLite
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3

      - name: Create backup directory
        run: mkdir -p /tmp/backups/sqlite

      - name: Create test SQLite database
        run: |
          # Create a test database for CI/CD
          # In production, this would be replaced with actual database path
          mkdir -p $HOME/.braindump/data
          sqlite3 $HOME/.braindump/data/braindump.db << EOF
          CREATE TABLE IF NOT EXISTS test (id INTEGER PRIMARY KEY, name TEXT);
          INSERT INTO test (name) VALUES ('test_data');
          EOF

      - name: Run SQLite backup
        env:
          BACKUP_DIR: /tmp/backups/sqlite
          SQLITE_DB_PATH: ${{ secrets.SQLITE_DB_PATH || '$HOME/.braindump/data/braindump.db' }}
        run: |
          chmod +x scripts/backup-sqlite.sh
          ./scripts/backup-sqlite.sh

      - name: Upload SQLite backup
        uses: actions/upload-artifact@v4
        with:
          name: sqlite-backup-${{ github.run_number }}
          path: /tmp/backups/sqlite/*.db.gz
          retention-days: 90
          if-no-files-found: warn

      - name: Check backup success
        run: |
          if ls /tmp/backups/sqlite/*.db.gz 1> /dev/null 2>&1; then
            echo "SQLite backup completed successfully"
          else
            echo "WARNING: SQLite backup file not found (may be expected if database doesn't exist)"
          fi

  backup-report:
    name: Backup Report
    runs-on: ubuntu-latest
    needs: [backup-postgres, backup-sqlite]
    if: always()

    steps:
      - name: Generate backup report
        run: |
          echo "## Database Backup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Database | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PostgreSQL | ${{ needs.backup-postgres.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SQLite | ${{ needs.backup-sqlite.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.backup-postgres.result }}" != "success" ] || [ "${{ needs.backup-sqlite.result }}" != "success" ]; then
            echo "⚠️ **One or more backups failed. Please investigate.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ **All backups completed successfully.**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "Backup job failed. In production, this would send notifications."
          echo "Consider setting up:"
          echo "  - Email notifications"
          echo "  - Slack/Discord webhooks"
          echo "  - PagerDuty alerts"
