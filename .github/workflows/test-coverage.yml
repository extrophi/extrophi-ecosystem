name: Test Coverage

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  rust-coverage:
    name: Rust Tests (Writer Module)
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install dependencies (macOS)
        run: |
          # Install whisper.cpp for transcription tests
          # Note: Skipping for now as it requires special setup
          # brew install whisper-cpp
          echo "Skipping whisper.cpp installation"

      - name: Cache cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            writer/src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Rust tests
        working-directory: writer/src-tauri
        run: |
          cargo test --lib --verbose

      - name: Generate coverage report (optional)
        working-directory: writer/src-tauri
        run: |
          # Install cargo-llvm-cov if needed
          cargo install cargo-llvm-cov || true
          cargo llvm-cov --lib --html || true
        continue-on-error: true

  python-backend-coverage:
    name: Python Tests (Backend Module)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-test.txt ]; then pip install -r requirements-test.txt; fi

      - name: Run backend tests with coverage
        working-directory: backend
        env:
          PYTHONPATH: /home/runner/work/extrophi-ecosystem/extrophi-ecosystem
        run: |
          pytest --cov=backend --cov-report=xml --cov-report=term-missing -v

      - name: Upload backend coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: backend/coverage.xml
          flags: backend
          name: backend-coverage
        continue-on-error: true

  python-research-coverage:
    name: Python Tests (Research Module)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-research-${{ hashFiles('**/requirements*.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio
          # Install backend dependencies (research depends on backend)
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
          if [ -f research/requirements.txt ]; then pip install -r research/requirements.txt; fi

      - name: Run research tests with coverage
        working-directory: research
        env:
          PYTHONPATH: /home/runner/work/extrophi-ecosystem/extrophi-ecosystem
        run: |
          pytest --cov=backend --cov-report=xml --cov-report=term-missing -v

      - name: Upload research coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: research/coverage.xml
          flags: research
          name: research-coverage
        continue-on-error: true

  coverage-summary:
    name: Coverage Summary
    runs-on: ubuntu-latest
    needs: [rust-coverage, python-backend-coverage, python-research-coverage]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "### Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Writer (Rust): Tests executed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Backend (Python): Tests executed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Research (Python): Tests executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual job logs for detailed coverage reports." >> $GITHUB_STEP_SUMMARY
