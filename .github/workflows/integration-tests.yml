name: Integration Tests

on:
  push:
    branches: [main, develop, "claude/*"]
  pull_request:
    branches: [main, develop]

jobs:
  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Create virtual environment
        run: |
          cd backend
          uv venv
          source .venv/bin/activate
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          cd backend
          uv pip install -e ".[dev]"
          uv pip install pytest pytest-asyncio pytest-cov httpx

      - name: Set environment variables
        run: |
          echo "DATABASE_URL=postgresql://test:test@localhost:5432/test_db" >> $GITHUB_ENV
          echo "REDIS_URL=redis://localhost:6379/1" >> $GITHUB_ENV
          echo "CHROMA_HOST=localhost" >> $GITHUB_ENV
          echo "CHROMA_PORT=8000" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=test-key-mock" >> $GITHUB_ENV
          echo "TESTING=true" >> $GITHUB_ENV

      - name: Run integration tests
        run: |
          cd /home/runner/work/extrophi-ecosystem/extrophi-ecosystem
          pytest tests/integration/ \
            -v \
            --tb=short \
            --cov=backend \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --maxfail=5 \
            --durations=10

      - name: Check test count
        run: |
          TEST_COUNT=$(pytest tests/integration/ --collect-only -q | grep -E "^test_" | wc -l)
          echo "Total tests: $TEST_COUNT"
          if [ "$TEST_COUNT" -lt 25 ]; then
            echo "ERROR: Expected at least 25 tests, found $TEST_COUNT"
            exit 1
          fi

      - name: Check coverage
        run: |
          COVERAGE=$(grep -oP 'Total coverage: \K[0-9.]+' coverage.txt || echo "0")
          echo "Coverage: $COVERAGE%"

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: integration
          name: integration-tests

      - name: Upload coverage HTML
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-html
          path: htmlcov/

      - name: Check test runtime
        run: |
          echo "Test runtime check: OK (enforced by timeout-minutes: 10)"

  test-summary:
    name: Test Summary
    needs: integration-tests
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "Integration tests failed!"
            exit 1
          fi
          echo "All integration tests passed! âœ…"
