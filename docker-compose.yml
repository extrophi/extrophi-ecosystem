version: '3.8'

services:
  # ============================================================================
  # Service Registry - Consul
  # ============================================================================
  consul:
    image: consul:1.17
    container_name: extrophi-consul
    ports:
      - "8500:8500"  # HTTP API + Web UI
      - "8600:8600/udp"  # DNS
    command: agent -server -ui -node=server-1 -bootstrap-expect=1 -client=0.0.0.0
    environment:
      - CONSUL_BIND_INTERFACE=eth0
    volumes:
      - consul_data:/consul/data
    networks:
      - extrophi-network
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ============================================================================
  # Database - PostgreSQL with pgvector
  # ============================================================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: extrophi-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=extrophi
      - POSTGRES_USER=extrophi
      - POSTGRES_PASSWORD=extrophi_dev_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/db/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - extrophi-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U extrophi"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Cache & Queue - Redis
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: extrophi-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - extrophi-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================================================
  # Backend API
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: extrophi-backend
    ports:
      - "8002:8000"
    environment:
      # Service Registry
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_NAME=backend-api
      - SERVICE_ADDRESS=backend
      - SERVICE_PORT=8000
      - SERVICE_TAGS=api,backend,publish

      # Database
      - DATABASE_URL=postgresql://extrophi:extrophi_dev_password@postgres:5432/extrophi
      - PGVECTOR_ENABLED=true

      # Redis
      - REDIS_URL=redis://redis:6379/0

      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      consul:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - extrophi-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # ============================================================================
  # Research API
  # ============================================================================
  research:
    build:
      context: ./research/backend
      dockerfile: Dockerfile
    container_name: extrophi-research
    ports:
      - "8001:8000"
    environment:
      # Service Registry
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_NAME=research-api
      - SERVICE_ADDRESS=research
      - SERVICE_PORT=8000
      - SERVICE_TAGS=api,research,enrichment

      # Database
      - DATABASE_URL=postgresql://extrophi:extrophi_dev_password@postgres:5432/extrophi
      - PGVECTOR_ENABLED=true

      # Redis
      - REDIS_URL=redis://redis:6379/0

      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LLM_MODEL=gpt-4

      # Scraper APIs (optional)
      - JINA_API_KEY=${JINA_API_KEY:-}
      - SCRAPER_API_KEY=${SCRAPER_API_KEY:-}
    depends_on:
      consul:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - extrophi-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # ============================================================================
  # Orchestrator API Gateway
  # ============================================================================
  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: extrophi-orchestrator
    ports:
      - "8003:8000"
    environment:
      # Service Registry
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_NAME=orchestrator-api
      - SERVICE_ADDRESS=orchestrator
      - SERVICE_PORT=8000
      - SERVICE_TAGS=api,orchestrator,gateway

      # Service Discovery (legacy static config as fallback)
      - BACKEND_URL=http://backend:8000
      - RESEARCH_URL=http://research:8000
    depends_on:
      consul:
        condition: service_healthy
      backend:
        condition: service_healthy
      research:
        condition: service_healthy
    networks:
      - extrophi-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

# ============================================================================
# Networks
# ============================================================================
networks:
  extrophi-network:
    driver: bridge
    name: extrophi-network

# ============================================================================
# Volumes
# ============================================================================
volumes:
  consul_data:
    name: extrophi-consul-data
  postgres_data:
    name: extrophi-postgres-data
  redis_data:
    name: extrophi-redis-data
